# This workflow is a daily cron job,
# running the tests of various third-party libraries that use us.
# This helps us spot regressions early,
# and helps flag when third-party libraries are making incorrect assumptions
# that might cause them to break when we cut a new release.

name: Third-party tests

on:
  schedule:
    - cron: "30 2 * * *"  # 02:30 UTC
  pull_request:
    paths:
      - ".github/workflows/third_party.yml"
  workflow_dispatch:

permissions:
  contents: read

env:
  PIP_DISABLE_PIP_VERSION_CHECK: 1
  FORCE_COLOR: 1

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  typing_inspect:
    name: typing_inspect tests
    if: >-
      # if 'schedule' was the trigger,
      # don't run it on contributors' forks
      ${{
        github.repository == 'python/typing_extensions'
        || github.event_name != 'schedule'
      }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.7", "3.8", "3.9", "3.10", "3.11"]
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout typing_inspect
        uses: actions/checkout@v3
        with:
          repository: ilevkivskyi/typing_inspect
      - name: Checkout typing_extensions
        uses: actions/checkout@v3
        with:
          path: typing-extensions-latest
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install typing_inspect test dependencies
        run: pip install -r test-requirements.txt
      - name: Install typing_extensions latest
        run: |
          pip uninstall typing_extensions --yes
          pip install ./typing-extensions-latest
      - name: List all installed dependencies
        run: pip freeze --all
      - name: Run typing_inspect tests
        run: pytest
